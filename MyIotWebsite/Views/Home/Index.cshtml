@{
    ViewData["Title"] = "Dashboard";
}

@section Styles {
    <style>
        /* --- CSS CHO VIDEO BACKGROUND --- */
        .video-background-container {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100vh;
            overflow: hidden; z-index: -2;
        }
        #bg-video {
            width: 100%; height: 100%;
            object-fit: cover;
        }
        .video-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: -1;
        }
        body {
            background-color: transparent;
        }

        .dashboard-card {
            background-color: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            height: 100%; /* Đảm bảo các card trong 1 hàng cao bằng nhau */
            color: #fff;
            transition: transform 0.2s ease-in-out;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }

        .dashboard-card h5 {
            color: #000B58;
        }

        .status-card {
            display: flex;
            align-items: center;
        }
        .status-card .icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
        }
        .status-card .icon.temp { background-color: rgba(220, 53, 69, 0.7); color: #ff8fa3; }
        .status-card .icon.hum { background-color: rgba(13, 110, 253, 0.7); color: #7afcff; }
        .status-card .icon.light { background-color: rgba(255, 193, 7, 0.7); color: #fff3b0; }

        /* --- CSS MỚI CHO DUST VÀ CO2 --- */
        .status-card .icon.dust { background-color: rgba(108, 117, 125, 0.7); color: #f8f9fa; }
        .status-card .icon.co2 { background-color: rgba(25, 135, 84, 0.7); color: #a3e9a4; }
        /* --- KẾT THÚC CSS MỚI --- */

        .status-card .info h6 {
            margin-bottom: 0.25rem;
            color: #000B58;
            font-size: 0.9rem;
        }
        .status-card .info .value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #000B58;
        }

        .control-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .control-card .info {
            display: flex;
            align-items: center;
        }
        .control-card .icon {
            font-size: 1.5rem;
            margin-right: 1rem;
        }

        .control-card .status {
            font-size: 0.8rem;
            color: #000B58;
        }

        .form-switch .form-check-input {
            width: 3.5em;
            height: 1.75em;
            cursor: pointer;
        }
        @@keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        /* --- CSS MỚI: Áp dụng cho cả 2 biểu đồ --- */
        #sensorChart, #dustCo2Chart {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;

            height: 300px !important;
        }
    </style>
}

<div class="video-background-container">
    <div class="video-overlay"></div>
    <video playsinline autoplay muted loop id="bg-video">
        <source src="~/videos/background-video.mp4" type="video/mp4">
        Trình duyệt của bạn không hỗ trợ video.
    </video>
</div>


<div class="container-fluid py-4">

    <div class="row row-cols-1 row-cols-md-3 row-cols-xl-5 g-4 mb-4">
        
        <div class="col">
            <div class="dashboard-card status-card"> <div class="icon temp"><i class="fas fa-thermometer-half"></i></div>
                <div class="info">
                    <h6>NHIỆT ĐỘ</h6>
                    <span class="value" id="temp-value">-- °C</span>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="dashboard-card status-card">
                <div class="icon hum"><i class="fas fa-tint"></i></div>
                <div class="info">
                    <h6>ĐỘ ẨM</h6>
                    <span class="value" id="hum-value">-- %</span>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="dashboard-card status-card">
                <div class="icon light"><i class="fas fa-sun"></i></div>
                <div class="info">
                    <h6>ÁNH SÁNG</h6>
                    <span class="value" id="light-value">-- %</span>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="dashboard-card status-card">
                <div class="icon dust"><i class="fas fa-smog"></i></div>
                <div class="info">
                    <h6>ĐỘ BỤI (PM2.5)</h6>
                    <span class="value" id="dust-value">--</span>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="dashboard-card status-card">
                <div class="icon co2"><i class="fas fa-wind"></i></div>
                <div class="info">
                    <h6>NỒNG ĐỘ CO2</h6>
                    <span class="value" id="co2-value">--</span>
                </div>
            </div>
        </div>

    </div>

    <div class="row">
        
        <div class="col-lg-8 mb-4">
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="dashboard-card"> <div> 
                            <h5 class="d-flex align-items-center mb-3">
                                <i class="fas fa-chart-line me-2"></i> Dash Board
                            </h5>
                            <canvas id="sensorChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-4">
                    <div class="dashboard-card"> <div> 
                            <h5 class="d-flex align-items-center mb-3">
                                <i class="fas fa-smog me-2"></i> Phân Tích Bụi & CO2
                            </h5>
                            <canvas id="dustCo2Chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="dashboard-card"> <h5 class="mb-3">Bảng Điều Khiển</h5>
                <div class="control-card mb-3">
                    <div class="info">
                        <span class="icon">💨</span>
                        <div>
                            <h5>Quạt</h5>
                            <span class="status" id="fan-status">Đang tải...</span>
                        </div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="fan-toggle">
                    </div>
                </div>
                <div class="control-card mb-3">
                    <div class="info">
                        <span class="icon">💡</span>
                        <div>
                            <h5>Đèn</h5>
                            <span class="status" id="light-status">Đang tải...</span>
                        </div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="light-toggle">
                    </div>
                </div>
                <div class="control-card">
                    <div class="info">
                        <span class="icon">❄️</span>
                        <div>
                            <h5>Điều hòa</h5>
                            <span class="status" id="ac-status">Đang tải...</span>
                        </div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="ac-toggle">
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="dashboard-card tech-footer text-center">
                <div class="d-flex justify-content-around align-items-center">
                    <a href="https://dotnet.microsoft.com/apps/aspnet" target="_blank" title="ASP.NET Core">
                        <img src="~/icons/Aspnet SVG Icon.svg" alt="ASP.NET Core" height="50">
                    </a>
                    <a href="https://mqtt.org/" target="_blank" title="MQTT">
                        <img src="~/icons/MQTT Horizontal Neg.svg" alt="MQTT" height="50">
                    </a>
                    <a href="https://www.espressif.com/en/products/socs/esp32" target="_blank" title="ESP32">
                        <img src="~/icons/Esp 32.svg" alt="ESP32" height="30" style="border-radius: 7px;">
                    </a>
                    <a href="https://en.gravatar.com/" target="_blank" title="Gravatar">
                        <img src="~/icons/Gravatar SVG Icon.svg" alt="Gravatar" height="50">
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
<script>
    let sensorChart;
    let dustCo2Chart; 
    const connection = new signalR.HubConnectionBuilder().withUrl("/sensorHub").build();

    async function updateLatestData() {
        try {
            const response = await fetch('/api/IotApi/sensordata/latest');
            if (!response.ok) return;
            const data = await response.json();

            if (data && data.temperature != null) {
                document.getElementById('temp-value').innerText = data.temperature.toFixed(1) + ' °C';
            }
            if (data && data.humidity != null) {
                document.getElementById('hum-value').innerText = data.humidity.toFixed(1) + ' %';
            }
            if (data && data.light != null) {
                document.getElementById('light-value').innerText = data.light.toFixed(1) + ' %';
            }

            if (data && data.dust != null) {
                document.getElementById('dust-value').innerText = data.dust.toFixed(0);
            }
            if (data && data.co2 != null) {
                document.getElementById('co2-value').innerText = data.co2.toFixed(0);
            }

        } catch (error) {
            console.error('Error fetching latest data:', error);
        }
    }

    async function updateChart() { 
        try {
            const response = await fetch('/api/IotApi/sensordata/history');
            if (!response.ok) return;
            const historyData = await response.json(); 

            const labels = historyData.map(d => new Date(d.timestamp).toLocaleTimeString('vi-VN'));
            const tempData = historyData.map(d => d.temperature);
            const humidityData = historyData.map(d => d.humidity);
            const lightData = historyData.map(d => d.light);

            const textColor = '#000B58';

            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: 'Nhiệt độ (°C)',
                        data: tempData,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        yAxisID: 'yTemp',
                        tension: 0.4
                    },
                    {
                        label: 'Độ ẩm (%)',
                        data: humidityData,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        yAxisID: 'yHum',
                        tension: 0.4
                    },
                    {
                        label:  'Ánh sáng (%)',
                        data: lightData,
                        borderColor: 'rgba(255, 206, 86, 1)',
                        yAxisID: 'yLight',
                        tension: 0.4
                    }
                ]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: textColor,
                            font: { size: 14 }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: textColor },
                        grid: { color: 'rgba(0, 11, 88, 0.1)' }
                    },
                    yTemp: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'Nhiệt độ (°C)', color: 'rgb(255, 99, 132)' },
                        ticks: { color: 'rgb(255, 99, 132)' }
                    },
                    yHum: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Độ ẩm (%)', color: 'rgb(54, 162, 235)' },
                        ticks: { color: 'rgb(54, 162, 235)' },
                        grid: { drawOnChartArea: false }
                    },
                    yLight: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Ánh sáng (%)', color: 'rgb(255, 206, 86)' },
                        ticks: { color: 'rgb(255, 206, 86)' },
                        grid: { drawOnChartArea: false }
                    }
                }
            };

            if (!sensorChart) {
                const canvas = document.getElementById('sensorChart');
                const ctx = canvas.getContext('2d');
                sensorChart = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: chartOptions
                });
            } else {
                sensorChart.data = chartData;
                sensorChart.options = chartOptions;
                sensorChart.update();
            }
        } catch (error) {
            console.log("Error updating sensor chart:", error);
        }
    }

    async function updateDustCo2Chart() {
        try {
            const response = await fetch('/api/IotApi/sensordata/history');
            if (!response.ok) return;

            let historyData = await response.json();

            if (historyData.length > 10) {
                historyData = historyData.slice(historyData.length - 10);
            }

            const labels = historyData.map(d => new Date(d.timestamp).toLocaleTimeString('vi-VN'));
            const dustData = historyData.map(d => d.dust);
            const co2Data = historyData.map(d => d.co2);

            const textColor = '#000B58';

            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: 'Độ Bụi (0-1000)',
                        data: dustData,
                        borderColor: 'rgba(108, 117, 125, 1)',
                        backgroundColor: 'rgba(108, 117, 125, 0.5)',
                        yAxisID: 'yDust',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'CO2 (0-100)',
                        data: co2Data,
                        borderColor: 'rgba(25, 135, 84, 1)',
                        backgroundColor: 'rgba(25, 135, 84, 0.5)',
                        yAxisID: 'yCo2',
                        tension: 0.3,
                        fill: true
                    }
                ]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: textColor,
                            font: { size: 14 }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: textColor },
                        grid: { color: 'rgba(0, 11, 88, 0.1)' }
                    },
                    yDust: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'Bụi (PM2.5)', color: 'rgb(108, 117, 125)' },
                        ticks: { color: 'rgb(108, 117, 125)' },
                        max: 1000 
                    },
                    yCo2: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'CO2', color: 'rgb(25, 135, 84)' },
                        ticks: { color: 'rgb(25, 135, 84)' },
                        grid: { drawOnChartArea: false },
                        max: 100 
                    }
                }
            };

            if (!dustCo2Chart) {
                const canvas = document.getElementById('dustCo2Chart');
                const ctx = canvas.getContext('2d');
                dustCo2Chart = new Chart(ctx, {
                    type: 'line', 
                    data: chartData,
                    options: chartOptions
                });
            } else {
                dustCo2Chart.data = chartData;
                dustCo2Chart.options = chartOptions;
                dustCo2Chart.update();
            }
        } catch (error) {
            console.log("Error updating Dust/CO2 chart:", error);
        }
    }

    async function toggleDevice(deviceName) {
        const cardElement = document.getElementById(`${deviceName}-toggle`).closest('.control-card');

        cardElement.classList.add('pending');

        try {
            await fetch(`/api/IotApi/devices/${deviceName}/toggle`, { method: 'POST' });
        } catch (error) {
            console.error(`Error toggling ${deviceName}:`, error);
            cardElement.classList.remove('pending');
        }
    }

    async function updateDeviceStates() {
        try {
            const response = await fetch('/api/IotApi/devicestates');
            if (!response.ok) {
                console.error(`Error fetching device states: ${response.status} ${response.statusText}`);
                const errorText = await response.text();
                console.error(errorText);
                return;
            }

            const devices = await response.json();

            devices.forEach(deviceState => {
                const deviceName = deviceState.deviceName.toLowerCase().trim();
                const statusElement = document.getElementById(`${deviceName}-status`);
                const toggleElement = document.getElementById(`${deviceName}-toggle`);

                if (statusElement && toggleElement) {
                    const cardElement = toggleElement.closest('.control-card');
                    cardElement.classList.remove('pending');

                    if (deviceState.isOn) {
                        statusElement.innerText = 'Đang Bật';
                        statusElement.className = 'status fw-bold text-success';
                    } else {
                        statusElement.innerText = 'Đang Tắt';
                        statusElement.className = 'status fw-bold text-secondary';
                    }
                    toggleElement.checked = deviceState.isOn;
                }
            });
        } catch (error) {
            console.error("Error fetching device states:", error);
        }
    }


    function updateSingleDevice(deviceState) {
        const deviceName = deviceState.deviceName.toLowerCase().trim();

        const statusElement = document.getElementById(`${deviceName}-status`);
        const toggleElement = document.getElementById(`${deviceName}-toggle`);

        const cardElement = toggleElement?.closest('.control-card');

        if (!statusElement || !toggleElement || !cardElement) {
            console.warn(`Không tìm thấy elements cho thiết bị: ${deviceName}`);
            return;
        }

        cardElement.classList.remove('pending');

        if (deviceState.isOn) {
            statusElement.innerText = 'Đang Bật';
            statusElement.className = 'status fw-bold text-success';
        } else {
            statusElement.innerText = 'Đang Tắt';
            statusElement.className = 'status fw-bold text-secondary';
        }

        toggleElement.checked = deviceState.isOn;
    }

    document.addEventListener('DOMContentLoaded', function() {

        function handleToggleClick(event, deviceName) {

            event.preventDefault();

            const cardElement = event.target.closest('.control-card');

            if (cardElement.classList.contains('pending')) {
                return;
            }

            toggleDevice(deviceName);
        }

        document.getElementById('fan-toggle').addEventListener('click', (e) => handleToggleClick(e, 'fan'));
        document.getElementById('light-toggle').addEventListener('click', (e) => handleToggleClick(e, 'light'));
        document.getElementById('ac-toggle').addEventListener('click', (e) => handleToggleClick(e, 'ac'));

        connection.on("ReceiveActionHistory", function (newAction) {
            console.log("Received action confirmation:", newAction);
            updateSingleDevice(newAction);
        });

        connection.on("ReceiveSensorData", function (newData) {
            updateLatestData();
            updateChart();
            updateDustCo2Chart(); 
        });

        async function start() {
            try {
                await connection.start();
                console.log("SignalR Connected.");
            } catch (err) {
                console.error("SignalR connection error: ", err);
                setTimeout(start, 5000);
                return; 
            }

            try {
                await updateLatestData();
            } catch (err) {
                console.error("Error during initial updateLatestData:", err);
            }

            try {
                await updateChart();
            } catch (err) {
                console.error("Error during initial updateChart:", err);
            }
            
            try {
                await updateDustCo2Chart();
            } catch (err) {
                console.error("Error during initial updateDustCo2Chart:", err);
            }

            try {
                await updateDeviceStates();
            } catch (err) {
                console.error("Error during initial updateDeviceStates:", err);
            }
        }

        start();
    });
</script>
}