@{
ViewData["Title"] = "Sensor Data";
}

@section Styles {
<style>
    .video-background-container {
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100vh;
        overflow: hidden; z-index: -2;
    }
    #bg-video {
        width: 100%; height: 100%;
        object-fit: cover;
    }
    .video-overlay {
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
        z-index: -1;
    }
    body { background-color: transparent; }

    .filter-card, .data-card {
        background-color: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        padding: 1.5rem;
    }
    .data-card { overflow: hidden; }
    .data-table { margin-bottom: 0; }
    .data-table thead th {
        background-color: #FDEB9E !important;
        color: #000B58 !important;
        border-bottom: none;
        vertical-align: middle;
    }
    .data-table tbody tr { transition: background-color 0.3s ease; animation: fadeIn 0.5s ease-out; }
    .new-row-highlight { animation: highlightFade 2s ease-out; }
    @@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @@keyframes highlightFade { 0% { background-color: #fff3cd; } 100% { background-color: transparent; } }

    /* --- CSS CHO CÁC GIÁ TRỊ --- */
    .text-value-high { color: #dc3545; font-weight: 500; }
    .text-value-low { color: #0d6efd; font-weight: 500; }
    .text-value-dust { color: #6c757d; font-weight: 500; } /* Màu cho Bụi */
    .text-value-co2 { color: #198754; font-weight: 500; }  /* Màu cho CO2 */


    /* --- CSS CHO SẮP XẾP --- */
    .sortable {
        cursor: pointer;
        user-select: none;
    }
    .sortable:hover {
        color: #0d6efd;
    }
    .sortable .sort-icon {
        color: #adb5bd;
        margin-left: 5px;
        transition: color 0.2s, transform 0.2s;
        display: inline-block;
    }
    .sortable.sorted .sort-icon {
        color: #000;
    }
    .sortable.asc .sort-icon {
        transform: rotate(0deg);
    }
    .sortable.desc .sort-icon {
        transform: rotate(180deg);
    }

</style>
}

<div class="video-background-container">
    <div class="video-overlay"></div>
    <video playsinline autoplay muted loop id="bg-video">
        <source src="~/videos/background-video.mp4" type="video/mp4">
    </video>
</div>

<h1 class="display-4">Tìm kiếm Dữ liệu Cảm biến</h1>
<p>Sử dụng bộ lọc thông minh để truy vấn dữ liệu.</p>

<div class="filter-card mb-4">
    <div class="row g-3 align-items-end">
        <div class="col-md-5">
            <label for="search-input" class="form-label"><i class="fas fa-keyboard me-2"></i>Nhập giá trị tìm kiếm</label>
            <input type="text" id="search-input" class="form-control" placeholder="Ví dụ: 30, 500, 2025-10-02..." />
        </div>
        <div class="col-md-3">
            <label for="search-type-select" class="form-label"><i class="fas fa-cogs me-2"></i>Loại tìm kiếm</label>
            <select id="search-type-select" class="form-select">
                <option value="ALL" selected>ALL</option>
                <option value="temperature">Nhiệt độ</option>
                <option value="humidity">Độ ẩm</option>
                <option value="light">Ánh sáng</option>
                <option value="dust">Độ Bụi</option>
                <option value="co2">CO2</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="pagesize-select" class="form-label"><i class="fas fa-list-ol me-2"></i>Số dòng</label>
            <select id="pagesize-select" class="form-select">
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="50">50</option>
            </select>
        </div>
        <div class="col-md-2">
            <button id="search-btn" class="btn btn-primary w-100">
                <i class="fas fa-search me-1"></i> Tìm
            </button>
        </div>
    </div>
</div>

<div class="data-card">
    <table class="table table-hover data-table">
        <thead>
        <tr>
            <th class="sortable" data-sortby="id">ID <i class="fas fa-sort-down sort-icon"></i></th>
            <th class="sortable" data-sortby="temperature">Nhiệt độ (°C) <i class="fas fa-sort-down sort-icon"></i></th>
            <th class="sortable" data-sortby="humidity">Độ ẩm (%) <i class="fas fa-sort-down sort-icon"></i></th>
            <th class="sortable" data-sortby="light">Ánh sáng (%)<i class="fas fa-sort-down sort-icon"></i></th>
            <th class="sortable" data-sortby="dust">Bụi (PM2.5) <i class="fas fa-sort-down sort-icon"></i></th>
            <th class="sortable" data-sortby="co2">CO2 <i class="fas fa-sort-down sort-icon"></i></th>
            <th class="sortable sorted desc" data-sortby="timestamp">Thời gian <i class="fas fa-sort-down sort-icon"></i></th>
        </tr>
        </thead>
        <tbody id="sensor-data-table-body"></tbody>
    </table>
</div>

<nav class="mt-4" aria-label="Page navigation">
    <ul class="pagination justify-content-center" id="pagination-controls"></ul>
</nav>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('search-input');
        const searchTypeSelect = document.getElementById('search-type-select');
        const pageSizeSelect = document.getElementById('pagesize-select');
        const searchButton = document.getElementById('search-btn');
        const paginationControls = document.getElementById('pagination-controls');
        const tableBody = document.getElementById('sensor-data-table-body');
        const tableHeaders = document.querySelectorAll('.sortable');

        let currentPage = 1;
        let currentSortBy = 'timestamp';
        let currentSortOrder = 'desc';

        function debounce(func, delay = 500) {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }
        const debouncedLoadData = debounce(() => loadSensorData(1), 500);

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear().toString().slice(-2);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        }

        function getValueClass(type, value) {
            if (type === 'temp') {
                if (value > 35) return 'text-value-high';
                if (value < 20) return 'text-value-low';
            }
            if (type === 'hum') {
                if (value > 80) return 'text-value-high';
                if (value < 40) return 'text-value-low';
            }
            if (type === 'dust') {
                if (value > 500) return 'text-value-dust';
            }
            if (type === 'co2') {
                if (value > 50) return 'text-value-co2';
            }
            return '';
        }

        async function loadSensorData(page = 1) {
            currentPage = page;
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center">Đang tải dữ liệu...</td></tr>`; 
            try {
                const params = new URLSearchParams();
                if (searchInput.value) {
                    params.append('searchTerm', searchInput.value.trim());
                }
                params.append('searchType', searchTypeSelect.value);
                params.append('pageNumber', currentPage);
                params.append('pageSize', pageSizeSelect.value);
                params.append('sortBy', currentSortBy);
                params.append('sortOrder', currentSortOrder);

                const apiUrl = `/api/IotApi/sensordata/search?${params.toString()}`;
                const response = await fetch(apiUrl);

                if (!response.ok){
                    if (response.status === 404) {
                        const errorMessage = await response.text();
                        tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger p-3">${errorMessage}</td></tr>`; // Cập nhật colspan
                    } else {
                        throw new Error(`Lỗi máy chủ hoặc API: ${response.status}`);
                    }
                    paginationControls.innerHTML = '';
                    return;
                }
                const paginatedResponse = await response.json();

                tableBody.innerHTML = '';

                if (paginatedResponse.data.length === 0) {
                    const message = searchInput.value
                        ? "Không tồn tại bất kỳ giá trị nào như bạn yêu cầu."
                        : "Chưa có dữ liệu nào.";
                    tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-warning p-3">${message}</td></tr>`; // Cập nhật colspan
                    paginationControls.innerHTML = '';
                    return;
                }

                paginatedResponse.data.forEach(record => {
                    const row = document.createElement('tr');

                    // --- CẬP NHẬT LOGIC VẼ BẢNG ---
                    row.insertCell(0).textContent = record.id;

                    const tempCell = row.insertCell(1);
                    tempCell.textContent = record.temperature.toFixed(1);
                    tempCell.className = getValueClass('temp', record.temperature);

                    const humCell = row.insertCell(2);
                    humCell.textContent = record.humidity.toFixed(1);
                    humCell.className = getValueClass('hum', record.humidity);

                    row.insertCell(3).textContent = record.light;

                    const dustCell = row.insertCell(4);
                    dustCell.textContent = record.dust.toFixed(0);
                    dustCell.className = getValueClass('dust', record.dust);

                    const co2Cell = row.insertCell(5);
                    co2Cell.textContent = record.co2.toFixed(0);
                    co2Cell.className = getValueClass('co2', record.co2);

                    row.insertCell(6).textContent = formatDateTime(record.timestamp);
                    // --- KẾT THÚC CẬP NHẬT ---

                    tableBody.appendChild(row);
                });
                renderPagination(paginatedResponse.totalPages, paginatedResponse.pageNumber);
            } catch (error) {
                console.error("Lỗi khi tải dữ liệu:", error);
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger p-3">Không thể tải dữ liệu. Vui lòng thử lại.</td></tr>';
            }
        }

        function renderPagination(totalPages, currentPage) {
            paginationControls.innerHTML = '';
            if (totalPages <= 1) return;

            const createPageItem = (page, text, isDisabled = false, isActive = false) => {
                const li = document.createElement('li');
                li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.innerText = text;
                if (!isDisabled) {
                    a.onclick = (e) => {
                        e.preventDefault();
                        loadSensorData(page);
                    };
                }
                li.appendChild(a);
                return li;
            };

            paginationControls.appendChild(createPageItem(currentPage - 1, 'Previous', currentPage === 1));

            const pageToShow = 5;
            let startPage, endPage;

            if (totalPages <= pageToShow) {
                startPage = 1;
                endPage = totalPages;
            } else {
                const maxPagesBeforeCurrentPage = Math.floor(pageToShow / 2);
                const maxPagesAfterCurrentPage = Math.ceil(pageToShow / 2) - 1;
                if (currentPage <= maxPagesBeforeCurrentPage) {
                    startPage = 1;
                    endPage = pageToShow;
                } else if (currentPage + maxPagesAfterCurrentPage >= totalPages) {
                    startPage = totalPages - pageToShow + 1;
                    endPage = totalPages;
                } else {
                    startPage = currentPage - maxPagesBeforeCurrentPage;
                    endPage = currentPage + maxPagesAfterCurrentPage;
                }
            }

            if (startPage > 1) {
                paginationControls.appendChild(createPageItem(1, '1'));
                if (startPage > 2) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = `<span class="page-link">...</span>`;
                    paginationControls.appendChild(li);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationControls.appendChild(createPageItem(i, i, false, i === currentPage));
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = `<span class="page-link">...</span>`;
                    paginationControls.appendChild(li);
                }
                paginationControls.appendChild(createPageItem(totalPages, totalPages));
            }

            paginationControls.appendChild(createPageItem(currentPage + 1, 'Next', currentPage === totalPages));
        }

        function updateSortUI() {
            tableHeaders.forEach(header => {
                const sortBy = header.getAttribute('data-sortby');
                header.classList.remove('sorted', 'asc', 'desc');
                if (sortBy === currentSortBy) {
                    header.classList.add('sorted', currentSortOrder);
                }
            });
        }

        // --- GẮN SỰ KIỆN CHO CÁC NÚT SẮP XẾP ---
        tableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const sortBy = header.getAttribute('data-sortby');
                if (!sortBy) return;

                if (currentSortBy === sortBy) {
                    currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortBy = sortBy;
                    currentSortOrder = (sortBy === 'timestamp') ? 'desc' : 'asc';
                }
                updateSortUI();
                loadSensorData(1);
            });
        });

        // --- GẮN CÁC SỰ KIỆN KHÁC ---
        searchButton.addEventListener('click', () => loadSensorData(1));
        pageSizeSelect.addEventListener('change', () => loadSensorData(1));
        searchTypeSelect.addEventListener('change', () => loadSensorData(1));
        searchInput.addEventListener('input', debouncedLoadData);
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                loadSensorData(1);
            }
        });

        const connection = new signalR.HubConnectionBuilder().withUrl("/sensorHub").build();
        connection.on("ReceiveSensorData", function (record) {
            if (currentPage === 1 && !searchInput.value && currentSortBy === 'timestamp' && currentSortOrder === 'desc') {
                const existingRows = tableBody.getElementsByTagName('tr');
                if (existingRows.length === 1 && existingRows[0].getElementsByTagName('td').length > 1) {
                    if (existingRows[0].querySelector('.text-warning, .text-danger, .text-center')) {
                        tableBody.innerHTML = '';
                    }
                }

                const row = document.createElement('tr');
                row.className = 'new-row-highlight';

                row.innerHTML = `<td>${record.id}</td>
                                    <td class="${getValueClass('temp', record.temperature)}">${record.temperature.toFixed(1)}</td>
                                    <td class="${getValueClass('hum', record.humidity)}">${record.humidity.toFixed(1)}</td>
                                    <td>${record.light}</td>
                                    <td class="${getValueClass('dust', record.dust)}">${record.dust.toFixed(0)}</td>
                                    <td class="${getValueClass('co2', record.co2)}">${record.co2.toFixed(0)}</td>
                                    <td>${formatDateTime(record.timestamp)}</td>`; 
                tableBody.prepend(row);

                const pageSize = parseInt(pageSizeSelect.value, 10);

                if (tableBody.rows.length > pageSize){
                    tableBody.deleteRow(tableBody.rows.length - 1);
                }
            }
        });

        async function start() {
            try {
                await connection.start();
                console.log("SignalR Connected.");
                updateSortUI();
                await loadSensorData(1);
            } catch (err) {
                console.error("Lỗi SignalR: ", err);
                setTimeout(start, 5000);
            }
        }

        start();
    });
</script>
}