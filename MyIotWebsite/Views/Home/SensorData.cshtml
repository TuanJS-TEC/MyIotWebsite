@{
ViewData["Title"] = "Sensor Data";
}

@section Styles {
<style>
    body { background-color: #f0f2f5; }
    .filter-card {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        padding: 1.5rem;
    }
    .data-card {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    .data-table { margin-bottom: 0; }
    .data-table thead th { background-color: #343a40 !important; color: #fff !important; border-bottom: none; }
    .data-table tbody tr { transition: background-color 0.3s ease; animation: fadeIn 0.5s ease-out; }
    .new-row-highlight { animation: highlightFade 2s ease-out; }
    @@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @@keyframes highlightFade { 0% { background-color: #fff3cd; } 100% { background-color: transparent; } }
    .text-value-high { color: #dc3545; font-weight: 500; }
    .text-value-low { color: #0d6efd; font-weight: 500; }
</style>
}

<h1 class="display-4">Tìm kiếm Dữ liệu Cảm biến</h1>
<p>Sử dụng bộ lọc thông minh để truy vấn dữ liệu.</p>

<div class="filter-card mb-4">
    <div class="row g-3 align-items-center">
        <div class="col-md-6">
            <label for="search-input" class="form-label"><i class="fas fa-keyboard me-2"></i>Nhập giá trị tìm kiếm</label>
            <input type="text" id="search-input" class="form-control" placeholder="Ví dụ: 30, >500, 2025-10-02..." />
        </div>

        <div class="col-md-4">
            <label for="search-type-select" class="form-label"><i class="fas fa-cogs me-2"></i>Loại tìm kiếm</label>
            <select id="search-type-select" class="form-select">
                <option value="smart" selected>Thông minh (SMART)</option>
                <option value="temperature">Nhiệt độ</option>
                <option value="humidity">Độ ẩm</option>
                <option value="light">Ánh sáng</option>
            </select>
        </div>

        <div class="col-md-2 d-flex align-items-end">
            <button id="search-btn" class="btn btn-primary w-100">
                <i class="fas fa-search me-1"></i> Tìm
            </button>
        </div>
    </div>
</div>


<div class="data-card">
    <table class="table table-hover data-table">
        <thead>
        <tr>
            <th>ID</th>
            <th>Nhiệt độ (°C)</th>
            <th>Độ ẩm (%)</th>
            <th>Ánh sáng</th>
            <th>Thời gian</th>
        </tr>
        </thead>
        <tbody id="sensor-data-table-body"></tbody>
    </table>
</div>
<nav class="mt-4">
    <ul class="pagination justify-content-center" id="pagination-controls"></ul>
</nav>

@section Scripts {
<script>
    // Khai báo các phần tử giao diện mới
    const searchInput = document.getElementById('search-input');
    const searchTypeSelect = document.getElementById('search-type-select');
    const searchButton = document.getElementById('search-btn');
    const paginationControls = document.getElementById('pagination-controls');
    const tableBody = document.getElementById('sensor-data-table-body');
    let currentPage = 1;

    function getValueClass(type, value) {
        if (type === 'temp') {
            if (value > 35) return 'text-value-high';
            if (value < 20) return 'text-value-low';
        }
        if (type === 'hum') {
            if (value > 80) return 'text-value-high';
            if (value < 40) return 'text-value-low';
        }
        return '';
    }

    async function loadSensorData(page = 1) {
        currentPage = page;
        try {
            const params = new URLSearchParams();

            if (searchInput.value) {
                params.append('searchTerm', searchInput.value);
            }
            params.append('searchType', searchTypeSelect.value);

            params.append('pageNumber', currentPage);
            params.append('pageSize', 10);

            const apiUrl = `/api/IotApi/sensordata/search?${params.toString()}`;
            const response = await fetch(apiUrl);

            if (!response.ok) throw new Error("Network response was not ok");
            const paginatedResponse = await response.json();

            tableBody.innerHTML = '';

            if (paginatedResponse.data.length === 0 && searchInput.value) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-warning">Không tồn tại bất kỳ giá trị nào như bạn yêu cầu.</td></tr>`;
                paginationControls.innerHTML = '';
                return;
            }

            paginatedResponse.data.forEach(record => {
                const row = `<tr>
                                <td>${record.id}</td>
                                <td class="${getValueClass('temp', record.temperature)}">${record.temperature.toFixed(1)}</td>
                                <td class="${getValueClass('hum', record.humidity)}">${record.humidity.toFixed(1)}</td>
                                <td>${record.light}</td>
                                <td>${new Date(record.timestamp).toLocaleString('vi-VN')}</td>
                             </tr>`;
                tableBody.innerHTML += row;
            });
            renderPagination(paginatedResponse.totalPages, paginatedResponse.pageNumber);
        } catch (error) {
            console.error("Lỗi khi tải dữ liệu:", error);
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Không thể tải dữ liệu.</td></tr>';
        }
    }

    function renderPagination(totalPages, currentPage) {
        paginationControls.innerHTML = '';
        if (totalPages <= 1) return;

        const pageToShow = 5;
        let startPage, endPage;

        if (totalPages <= pageToShow + 2) {
            startPage = 1;
            endPage = totalPages;
        } else {
            if (currentPage <= Math.ceil(pageToShow / 2)) {
                startPage = 1;
                endPage = pageToShow;
            } else if (currentPage + Math.floor(pageToShow / 2) >= totalPages) {
                startPage = totalPages - pageToShow + 1;
                endPage = totalPages;
            } else {
                startPage = currentPage - Math.floor(pageToShow / 2);
                endPage = currentPage + Math.floor(pageToShow / 2);
            }
        }

        let html = '';
        html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" onclick="event.preventDefault(); loadSensorData(${currentPage - 1})">Previous</a></li>`;
        if (startPage > 1) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); loadSensorData(1)">1</a></li>`;
            if (startPage > 2) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        for (let i = startPage; i <= endPage; i++) {
            html += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="event.preventDefault(); loadSensorData(${i})">${i}</a></li>`;
        }
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            html += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); loadSensorData(${totalPages})">${totalPages}</a></li>`;
        }
        html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" onclick="event.preventDefault(); loadSensorData(${currentPage + 1})">Next</a></li>`;
        paginationControls.innerHTML = html;
    }

    const connection = new signalR.HubConnectionBuilder().withUrl("/sensorHub").build();
    connection.on("ReceiveSensorData", function (record) {
        if (currentPage === 1 && !searchInput.value) {
            const row = document.createElement('tr');
            row.className = 'new-row-highlight';
            row.innerHTML = `<td>${record.id}</td>
                             <td class="${getValueClass('temp', record.temperature)}">${record.temperature.toFixed(1)}</td>
                             <td class="${getValueClass('hum', record.humidity)}">${record.humidity.toFixed(1)}</td>
                             <td>${record.light}</td>
                             <td>${new Date(record.timestamp).toLocaleString('vi-VN')}</td>`;
            tableBody.prepend(row);
            if (tableBody.rows.length > 10) {
                tableBody.deleteRow(tableBody.rows.length - 1);
            }
        }
    });

    searchButton.addEventListener('click', () => loadSensorData(1));
    searchInput.addEventListener('keyup', (event) => {
        if (event.key === 'Enter') {
            loadSensorData(1);
        }
    });

    async function start() {
        try {
            await connection.start();
            console.log("SignalR Connected.");
            await loadSensorData(1);
        } catch (err) {
            console.error(err);
            setTimeout(start, 5000);
        }
    };
    start();
</script>
}